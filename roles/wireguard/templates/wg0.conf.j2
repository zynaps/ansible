[Interface]
PrivateKey = {{ wireguard.private_key }}
Address = {{ wireguard.ip + '/32' }}
{% if wireguard.exit_node is sameas true %}
PostUp = iptables -t nat -I POSTROUTING 1 -s {{ wireguard.network }} -o en+ -j MASQUERADE
PostUp = iptables -I FORWARD 1 -o %i -j ACCEPT
PostUp = iptables -I FORWARD 2 -i %i -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -s {{ wireguard.network }} -o en+ -j MASQUERADE
PostDown = iptables -D FORWARD -o %i -j ACCEPT
PostDown = iptables -D FORWARD -i %i -j ACCEPT
{% endif %}
ListenPort = 51820
{% for host in groups.wireguard|reject('==', inventory_hostname) %}

[Peer] # {{ host }}
PublicKey = {{ hostvars[host].wireguard.public_key }}
{% if wireguard.default_gateway is defined and wireguard.default_gateway == host  %}
AllowedIPs = 0.0.0.0/0
{% else %}
AllowedIPs = {{ hostvars[host].wireguard.ip + '/32' }}
{% endif %}
PersistentKeepalive = 23
Endpoint = {{ hostvars[host].wireguard.endpoint }}
{% endfor %}
