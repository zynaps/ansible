---
- name: bootstrap host
  hosts: all
  gather_facts: no
  user: root

  tasks:
    - name: install python3 packages
      raw: apt install -y python3-pip python3-apt

    - setup:

    - name: full upgrade host
      apt:
        update_cache: yes
        upgrade: full
      register: apt_full_upgrade

    - debug:
        msg={{ apt_full_upgrade.stdout + apt_full_upgrade.stderr }}

    - block:
      - name: set new hostname
        hostname:
          name: "{{ inventory_hostname_short }}"
          use: systemd

      - name: editing /etc/hosts file
        replace:
          path: /etc/hosts
          regexp: "{{ origin_host }}"
          replace: "{{ inventory_hostname_short }}"

      - name: set new ip address
        replace:
          path: /etc/network/interfaces.d/enp0s8
          regexp: "{{ origin_ip }}"
          replace: "{{ target_ip }}"

      - name: find sshd host keys
        find:
          path: /etc/ssh
          pattern: 'ssh_host_\w+_key(\.pub)?'
          use_regex: yes
        register: files_to_delete

      - name: remove sshd host keys
        file:
          path: "{{ item.path }}"
          state: absent
        with_items: "{{ files_to_delete.files }}"

      - name: regenerate sshd host keys
        command: ssh-keygen -A

      - name: shutdown host
        command: shutdown -h +1

      - meta: end_host
      when: origin_host is defined
