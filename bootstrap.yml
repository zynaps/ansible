---
- name: bootstrap host
  hosts: all
  user: root

  pre_tasks:
    - import_role:
        name: apt_update

    - name: full upgrade host
      apt:
        upgrade: full
      register: apt_full_upgrade

    - debug:
        msg={{ apt_full_upgrade.stdout + apt_full_upgrade.stderr }}

    - block:
      - name: detect cloned machine
        set_fact:
          cloned_machine: yes
      when: ansible_hostname != inventory_hostname_short

    - block:
      - name: set new hostname
        hostname:
          name: "{{ inventory_hostname_short }}"

      - name: edit /etc/hosts file
        replace:
          path: /etc/hosts
          regexp: "{{ ansible_hostname }}"
          replace: "{{ inventory_hostname_short }}"

      - name: regenerate sshd host keys
        command: ssh-keygen -A

      - name: reboot the machine with new defaults
        reboot:
      when: cloned_machine is sameas true

  roles:
    - users
    - root_lock
