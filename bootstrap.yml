---
- name: bootstrap host
  hosts: all
  user: root

  pre_tasks:
    - name: check if system was cloned
      set_fact:
        system_cloned: yes
      when: ansible_hostname != inventory_hostname_short

    - block:
      - name: set new hostname
        hostname:
          name: "{{ inventory_hostname_short }}"

      - name: edit /etc/hosts file
        replace:
          path: /etc/hosts
          regexp: "{{ ansible_hostname }}"
          replace: "{{ inventory_hostname_short }}"

      - name: list current sshd keys
        find:
          paths: /etc/ssh
          patterns: ssh_host_*_key*
        register: sshd_keys

      - name: delete current sshd keys
        file:
          path: "{{ item }}"
          state: absent
        loop: "{{ sshd_keys.files|map(attribute='path')|sort }}"

      - name: regenerate sshd keys
        command: ssh-keygen -A
        changed_when: yes
      when: system_cloned is sameas true

    - name: disable ipv6
      sysctl:
        name: net.ipv6.conf.all.disable_ipv6
        value: '1'
        sysctl_file: /etc/sysctl.d/90-disable_ipv6.conf
        sysctl_set: yes

    - name: apply sshd system-wide settings
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?\\s*{{ item.key }}\\s+"
        line: "{{ item.key }} {{ item.value }}"
      loop:
        - { key: 'AddressFamily', value: 'inet' }
        - { key: 'ClientAliveInterval', value: '16' }
        - { key: 'ClientAliveCountMax', value: '16' }
        - { key: 'TCPKeepAlive', value: 'no' }
        - { key: 'PasswordAuthentication', value: 'no' }
      notify: reload sshd

    - meta: flush_handlers

  roles:
    - users

  handlers:
    - name: reload sshd
      systemd:
        name: ssh
        state: reloaded

- name: common hosts roles
  hosts: all
  become: yes

  roles:
    - common_packages
    - vnstat
    - wireguard
    - docker
    - docker_registry
